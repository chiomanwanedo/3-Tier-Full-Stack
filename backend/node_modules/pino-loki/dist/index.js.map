{"version":3,"file":"index.js","names":["value: any","path: string","defaultValue?: TDefault","current: any","options: { log: LogFormatExpectedObject; logFormat: LogFormat }","options?: BuilderOptions","#propsToLabels","#levelMap","log: PinoLog","replaceTimestamp?: boolean","convertArrays?: boolean","value","labels: Record<string, string>","level: number","options: {\n    log: PinoLog\n    replaceTimestamp?: boolean\n    additionalLabels?: Record<string, string>\n    convertArrays?: boolean\n    structuredMetaKey?: string\n    logFormat?: LogFormat\n  }","#buildTimestamp","#buildLabelsFromProps","structuredMetadata: Record<string, any>","#stringifyLog","message: string","responseBody: string","options: LokiOptions","#options","#logBuilder","err: any","logs: PinoLog[] | PinoLog","#handleFailure","options: LokiOptions","userOptions: LokiOptions","batchInterval: NodeJS.Timeout | undefined","pinoLogBuffer: PinoLog[]"],"sources":["../src/debug.ts","../src/constants.ts","../src/get.ts","../src/format_mesage.ts","../src/log_builder.ts","../src/log_pusher.ts","../src/index.ts"],"sourcesContent":["import { debuglog } from 'node:util'\n\nexport default debuglog('pino-loki')\n","/* eslint-disable @typescript-eslint/no-redeclare */\nexport const LokiLogLevel = {\n  Info: 'info',\n  Debug: 'debug',\n  Error: 'error',\n  Warning: 'warning',\n  Critical: 'critical',\n} as const\n\nexport type LokiLogLevel = (typeof LokiLogLevel)[keyof typeof LokiLogLevel]\n","/**\n * Dynamically get a nested value from an array or object with a\n * string.\n */\nexport function get<TDefault = unknown>(\n  value: any,\n  path: string,\n  defaultValue?: TDefault,\n): TDefault {\n  const segments = path.split(/[.[\\]]/g)\n  let current: any = value\n\n  for (const key of segments) {\n    if (current === null) return defaultValue as TDefault\n    if (current === undefined) return defaultValue as TDefault\n\n    const unquotedKey = key.replace(/[\"']/g, '')\n    if (unquotedKey.trim() === '') continue\n\n    current = current[unquotedKey]\n  }\n\n  if (current === undefined) return defaultValue as TDefault\n  return current\n}\n","import { get } from './get.ts'\nimport type { LogFormat, LogFormatExpectedObject } from './types.ts'\n\nexport function formatLog(options: { log: LogFormatExpectedObject; logFormat: LogFormat }): string {\n  const { log, logFormat } = options\n\n  if (logFormat && typeof logFormat === 'string') {\n    return logFormat.replace(/{([^{}]+)}/g, (_match, p1) => get(log, p1) || '')\n  }\n\n  if (logFormat && typeof logFormat === 'function') {\n    return logFormat(options.log)\n  }\n\n  throw new Error('Message format must be a string or a function. Received: ' + typeof logFormat)\n}\n","import { LokiLogLevel } from './constants.ts'\nimport { formatLog } from './format_mesage.ts'\nimport type { LokiLog, PinoLog, LokiOptions, LogFormat, LogFormatExpectedObject } from './types.ts'\n\nconst NANOSECONDS_LENGTH = 19\n\ntype BuilderOptions = Pick<LokiOptions, 'propsToLabels' | 'levelMap'>\n\n/**\n * Converts a Pino log to a Loki log\n */\nexport class LogBuilder {\n  #propsToLabels: string[]\n  #levelMap: { [key: number]: LokiLogLevel }\n\n  constructor(options?: BuilderOptions) {\n    this.#propsToLabels = options?.propsToLabels || []\n    this.#levelMap = Object.assign(\n      {\n        10: LokiLogLevel.Debug,\n        20: LokiLogLevel.Debug,\n        30: LokiLogLevel.Info,\n        40: LokiLogLevel.Warning,\n        50: LokiLogLevel.Error,\n        60: LokiLogLevel.Critical,\n      },\n      options?.levelMap,\n    )\n  }\n\n  /**\n   * Builds a timestamp string from a Pino log object.\n   * @returns A string representing the timestamp in nanoseconds.\n   */\n  #buildTimestamp(log: PinoLog, replaceTimestamp?: boolean): string {\n    if (replaceTimestamp) {\n      return (new Date().getTime() * 1_000_000).toString()\n    }\n\n    const time = log.time || Date.now()\n    const strTime = time.toString()\n\n    // Returns the time if it's already in nanoseconds\n    if (strTime.length === NANOSECONDS_LENGTH) {\n      return strTime\n    }\n\n    // Otherwise, find the missing factor to convert it to nanoseconds\n    const missingFactor = 10 ** (19 - strTime.length)\n    return (time * missingFactor).toString()\n  }\n\n  /**\n   * Stringify the log object. If convertArrays is true then it will convert\n   * arrays to objects with indexes as keys.\n   */\n  #stringifyLog(log: PinoLog, convertArrays?: boolean): string {\n    return JSON.stringify(log, (_, value) => {\n      if (!convertArrays) return value\n\n      if (Array.isArray(value)) {\n        return Object.fromEntries(value.map((value, index) => [index, value]))\n      }\n\n      return value\n    })\n  }\n\n  #buildLabelsFromProps(log: PinoLog) {\n    const labels: Record<string, string> = {}\n\n    for (const prop of this.#propsToLabels) {\n      if (log[prop]) {\n        labels[prop] = log[prop]\n      }\n    }\n\n    return labels\n  }\n\n  /**\n   * Convert a level to a human readable status\n   */\n  statusFromLevel(level: number) {\n    return this.#levelMap[level] || LokiLogLevel.Info\n  }\n\n  /**\n   * Build a loki log entry from a pino log\n   */\n  build(options: {\n    log: PinoLog\n    replaceTimestamp?: boolean\n    additionalLabels?: Record<string, string>\n    convertArrays?: boolean\n    structuredMetaKey?: string\n    logFormat?: LogFormat\n  }): LokiLog {\n    const status = this.statusFromLevel(options.log.level)\n    const time = this.#buildTimestamp(options.log, options.replaceTimestamp)\n    const propsLabels = this.#buildLabelsFromProps(options.log)\n\n    const hostname = options.log.hostname\n    options.log.hostname = undefined\n\n    const structuredMetadata: Record<string, any> = options.structuredMetaKey\n      ? options.log[options.structuredMetaKey]\n      : undefined\n\n    const formattedMessage = options.logFormat\n      ? formatLog({\n          logFormat: options.logFormat,\n          log: { ...options.log, lokilevel: status } as LogFormatExpectedObject,\n        })\n      : this.#stringifyLog(options.log, options.convertArrays)\n\n    return {\n      stream: {\n        level: status,\n        hostname,\n        ...options.additionalLabels,\n        ...propsLabels,\n      },\n      values: [\n        // Make sure to exclude structured metadata from the log object\n        // if not present because olders versions of Loki will not accept\n        // it and will return an error.\n        structuredMetadata\n          ? [time, formattedMessage, structuredMetadata]\n          : [time, formattedMessage],\n      ],\n    }\n  }\n}\n","import debug from './debug.ts'\nimport { LogBuilder } from './log_builder.ts'\nimport type { PinoLog, LokiOptions } from './types.ts'\n\nclass RequestError extends Error {\n  responseBody: string\n\n  constructor(message: string, responseBody: string) {\n    super(message)\n    this.name = 'RequestError'\n    this.responseBody = responseBody\n  }\n}\n\n/**\n * Responsible for pushing logs to Loki\n */\nexport class LogPusher {\n  #options: LokiOptions\n  #logBuilder: LogBuilder\n\n  constructor(options: LokiOptions) {\n    this.#options = options\n\n    this.#logBuilder = new LogBuilder({\n      levelMap: options.levelMap,\n      propsToLabels: options.propsToLabels,\n    })\n  }\n\n  /**\n   * Handle push failures\n   */\n  #handleFailure(err: any) {\n    if (this.#options.silenceErrors === true) {\n      return\n    }\n\n    if (err instanceof RequestError) {\n      console.error(err.message + '\\n' + err.responseBody)\n      return\n    }\n\n    console.error('Got unknown error when trying to send log to Loki, error output:', err)\n  }\n\n  /**\n   * Push one or multiples logs entries to Loki\n   */\n  async push(logs: PinoLog[] | PinoLog) {\n    if (!Array.isArray(logs)) {\n      logs = [logs]\n    }\n\n    const lokiLogs = logs.map((log) =>\n      this.#logBuilder.build({\n        log,\n        replaceTimestamp: this.#options.replaceTimestamp,\n        additionalLabels: this.#options.labels,\n        convertArrays: this.#options.convertArrays,\n        structuredMetaKey: this.#options.structuredMetaKey,\n        logFormat: this.#options.logFormat,\n      }),\n    )\n\n    debug(`[LogPusher] pushing ${lokiLogs.length} logs to Loki`)\n\n    try {\n      const response = await fetch(\n        new URL(this.#options.endpoint ?? 'loki/api/v1/push', this.#options.host),\n        {\n          method: 'POST',\n          signal: AbortSignal.timeout(this.#options.timeout ?? 30_000),\n          headers: {\n            ...this.#options.headers,\n            ...(this.#options.basicAuth && {\n              Authorization:\n                'Basic ' +\n                Buffer.from(\n                  `${this.#options.basicAuth.username}:${this.#options.basicAuth.password}`,\n                ).toString('base64'),\n            }),\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({ streams: lokiLogs }),\n        },\n      )\n\n      if (!response.ok) {\n        throw new RequestError('Got error when trying to send log to loki', await response.text())\n      }\n    } catch (err) {\n      this.#handleFailure(err)\n    }\n\n    debug(`[LogPusher] pushed ${lokiLogs.length} logs to Loki`, { logs: lokiLogs })\n  }\n}\n","import abstractTransportBuild from 'pino-abstract-transport'\n\nimport debug from './debug.ts'\nimport { LogPusher } from './log_pusher.ts'\nimport { LokiLogLevel } from './constants.ts'\nimport type { PinoLog, LokiOptions } from './types.ts'\n\n/**\n * Resolves the options for the Pino Loki transport\n */\nfunction resolveOptions(options: LokiOptions) {\n  return {\n    ...options,\n    endpoint: options.endpoint ?? 'loki/api/v1/push',\n    timeout: options.timeout ?? 30_000,\n    silenceErrors: options.silenceErrors ?? false,\n    batching: options.batching ?? true,\n    interval: options.interval ?? 5,\n    replaceTimestamp: options.replaceTimestamp ?? false,\n    propsToLabels: options.propsToLabels ?? [],\n    convertArrays: options.convertArrays ?? false,\n    structuredMetaKey: options.structuredMetaKey,\n    logFormat: options.logFormat,\n  }\n}\n\nfunction pinoLoki(userOptions: LokiOptions) {\n  const options = resolveOptions(userOptions)\n  const logPusher = new LogPusher(options)\n\n  debug(`[PinoLoki] initialized with options: ${JSON.stringify(options)}`)\n\n  let batchInterval: NodeJS.Timeout | undefined\n  let pinoLogBuffer: PinoLog[] = []\n\n  return abstractTransportBuild(\n    async (source) => {\n      if (options.batching) {\n        batchInterval = setInterval(async () => {\n          debug(`Batch interval reached, sending ${pinoLogBuffer.length} logs to Loki`)\n\n          if (pinoLogBuffer.length === 0) {\n            return\n          }\n\n          logPusher.push(pinoLogBuffer)\n          pinoLogBuffer = []\n        }, options.interval! * 1000)\n      }\n\n      for await (const obj of source) {\n        if (options.batching) {\n          pinoLogBuffer.push(obj)\n          continue\n        }\n\n        logPusher.push(obj)\n      }\n    },\n    {\n      /**\n       * When transport is closed, push remaining logs to Loki\n       * and clear the interval\n       */\n      async close() {\n        if (options.batching) {\n          clearInterval(batchInterval!)\n          await logPusher.push(pinoLogBuffer)\n        }\n      },\n    },\n  )\n}\n\nexport default pinoLoki\nexport { LokiLogLevel, pinoLoki, type LokiOptions, type PinoLog }\n"],"mappings":"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"}